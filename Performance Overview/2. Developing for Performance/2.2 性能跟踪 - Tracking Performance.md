## 2.2 性能跟踪 - Tracking Performance
确保高性能的唯一方法是在产品设计中包含性能目标，并在整个开发过程中针对这些目标测量产品。高性能不是在开发周期结束时可以植入代码的功能，它与该周期密切相关。编写代码时，了解其对程序整体性能的影响非常重要。如果您尽早发现性能问题，那么您有很好的机会在太迟之前修复它们。

确定您是否达到或超过特定性能目标的方法是收集指标。**Apple** 提供了几种工具来监视和分析程序的性能。您还可以将测量工具直接构建到您的代码中，以帮助自动化收集数据的过程。无论您选择哪种方法，都需要定期运用这些工具并分析结果。

### 2.2.1 建立基准指标 - Establish Your Baseline Metrics
您需要做的第一件事就是决定一组您要衡量的基准指标。选择您认为对用户来说最重要的任务，并确定执行这些任务的一组约束。例如，您可能希望应用程序在不到 **1** 秒的时间内加载并显示初始窗口，或者您可能希望将总内存使用量保持在给定的目标范围内。

您选择测量的任务应该反映用户的需求。营销部门应该能够帮助您选择一组用户认为有意义的任务。如果您拥有已建立的产品，请与您的用户交谈，并了解他们认为哪些功能较慢，并考虑在计划的更新中提高这些功能的性能。

一旦你有了你想跟踪的任务列表，你需要确定每个任务的性能目标。对于现有产品，您可能只是试图改进以前版本的性能。您也可以尝试衡量竞争产品的性能，并设定达到或超过其性能的目标。如果您有新产品，您可能需要尝试使用数字来找到合理的值。或者，您可能希望建立积极的基准值并尽可能尝试接近它们。

与任何性能测量一样，一致性非常重要。您建立基准指标的流程应该包含您收集这些指标的系统信息。详细记录系统的硬件和软件配置，并始终针对相同配置运行测试。尝试使用尽可能慢的硬件配置来建立基线。在快速机器上进行测量可能会使您相信您的软件运行良好，但许多用户将使用运行速度较慢的处理器和较少内存的计算机。

### 2.2.2 早测量，常测量 - Measure Early, Measure Often
性能数据不是您可以收集一次就能找到程序中的所有性能瓶颈。如果您保持程序性能的历史记录，则更容易发现问题。通过维护历史记录，可以轻松查看应用程序的性能是提高还是下降。如果数据下降，您可以在产品发布前采取措施纠正问题。

定期测量性能的另一个原因是您可以将这些结果与代码签入关联起来。如果特定里程碑的性能下降，您可以查看在此期间签入的代码并尝试找出原因。同样，如果性能提高，您可以使用最近的代码签入作为优秀编程实践的模型，并鼓励您的团队使用类似的技术。

只要有部分功能的程序，您就应该开始进行性能测量。随着新功能的添加，您可以为这些功能添加测量。将一组自动诊断程序直接结合到您的程序中可以让您的团队成员立即看到结果。掌握这些信息可以让他们在检查代码之前更容易解决性能问题。

### 2.2.3 分析你的结果 - Analyze Your Results
收集数据是识别性能瓶颈的最重要步骤。 但是，一旦你有了这些数据，使用它来发现问题也很重要。分析性能数据并不像查看输出然后马上看到问题那么简单。可能你会很幸运，并迅速看到问题，但有些问题较为微妙，需要更仔细的分析。

帮助分析结果的一种方法是以图形方式绘制它们。与电子表格或其他基于文本的媒体相比，可视化效果数据可以帮助您更快地看到趋势。例如，您可以绘制时间来完成针对特定构建的单个操作，以确定构建过程中性能是提高还是下降。根据相同的一系列里程碑绘制多个数据集也可能会揭示趋势，并提供有关性能增长或下降的原因。

#### 分析更高级的算法 - Analyze Higher-Level Algorithms
在分析性能数据时，请对问题所在的抽象级别保持开放的态度。假设你拥有的数据表明在一个特定的函数中花了很多时间。这可能是函数本身中的代码可以优化以使其执行得更快，但是问题的真正原因是什么？再次运行你的程序，但这次检查函数被调用的次数。如果函数被调用一百万次，那么问题可能出现在首先调用它的较高级别的算法中。如果函数被调用一次，问题可能出在函数的主体上。

> 注意：**Instruments** 是分析程序运行时行为的强大工具。 **Instruments** 可让您记录多个指标并将其并排显示，从而更容易发现趋势。**Instrument** 的数据挖掘功能是另一种快速识别高级算法中问题的好方法。有关 **Instruments** 和其他 **Apple** 提供的工具的更多信息，请参阅 **Performance Tools**。

**Performance Tools** 本身有一些局限性，您需要在分析数据时理解和考虑。例如，抽样程序可能会指出你的应用程序花费大量时间的地方，但您应该了解这些工具在得出结论之前是如何收集数据的。采样工具不会跟踪每个函数调用。相反，他们根据以固定时间间隔采集的样本对您的程序进行统计分析。使用这些工具的输出作为指导，但一定要将其与您记录的其他数据相关联。

#### 其他分析技术 - Other Analysis Techniques
如果您对性能问题的真正原因持怀疑态度，请避免对问题的原因进行假设。相反，通过将数据收集工作集中在相关代码上来优化分析。尝试使用不同的工具来收集新类型的信息。一个不同的工具可能会提供一个独特的视角，更多地揭示实际问题。

您可以分析程序的其他一些方法包括：

* 在调试器中观看代码。 在调试器中遍历代码可能会发现导致代码速度降低的逻辑错误。
* 向代码添加检查点（checkpoints）以记录有关代码执行时间的信息。 有关使用检查点跟踪初始化代码的示例，请参阅 **Launch Time Performance Guidelines**。
* 尝试用替代解决方案编码，看看他们是否遇到类似的问题。
