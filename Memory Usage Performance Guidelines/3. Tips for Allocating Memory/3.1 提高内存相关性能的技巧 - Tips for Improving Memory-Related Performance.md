## 3.1 提高内存相关性能的技巧 - Tips for Improving Memory-Related Performance

当你在设计代码时，你应该时刻注意如何使用内存。因为内存是重要的资源，所以你要确保有效地使用它，而不是浪费。 除了为给定操作分配适量的内存之外，以下各节还介绍了提高程序内存使用效率的其他方法。

### 3.1.1 推迟你的内存分配 - Defer Your Memory Allocations

每个内存分配都有一个性能成本。该成本包括在程序的逻辑地址空间中分配内存所需的时间以及将该地址空间赋值（assign）给物理内存所需的时间。如果您不打算立即使用特定的内存块，则将分配推迟到实际需要时为止，这是最好的行动方案。例如，为了避免您的应用程序启动缓慢，请尽量减少启动时分配的内存量。相反，请将初始内存分配集中在显示用户界面和对来自用户的输入做出响应所需的对象上。延迟其他分配，直到用户问题开始与应用程序交互并发出命令。内存的这种懒惰分配可以立即节省时间，并确保分配的任何内存都被实际使用。

懒惰初始化可能有点棘手的地方是全局变量。因为它们对于你的应用程序是全局的，所以你需要确保全局变量在它们被其他代码使用之前被正确初始化。常用于全局变量的基本方法是在您的一个代码模块中定义静态变量，并使用公共访问函数来获取和设置值，如清单1所示。

Listing 1  Lazy allocation of memory through an accessor

```
MyGlobalInfo* GetGlobalBuffer()
{
    static MyGlobalInfo* sGlobalBuffer = NULL;
    if ( sGlobalBuffer == NULL )
        {
            sGlobalBuffer = malloc( sizeof( MyGlobalInfo ) );
        }
        return sGlobalBuffer;
}
```

你必须小心使用这种类型的代码，当你可能会从多个线程中调用它时。在多线程环境中，您需要使用锁来保护访问器方法中的 if 语句。尽管如此，这种方法的缺点是获取锁需要花费不菲的时间，并且在每次访问全局变量时都必须完成，这是另一种不同类型的性能影响。更简单的方法是在应用程序主线程产生任何附加线程之前初始化所有全局变量。

### 3.1.2 高效地初始化内存块 - Initialize Memory Blocks Efficiently
使用 `malloc` 函数分配的小块内存不保证用零初始化。 尽管可以使用 `memset` 函数来初始化内存，但更好的选择是使用`calloc` 例程来首先分配内存。`calloc` 函数为内存保留所需的虚拟地址空间，但在初始化之前一直等到内存实际使用。 这种方法比使用 `memset` 更有效率，这会强制虚拟内存系统将相应的页面映射到物理内存中，以便对它们进行零初始化。 使用 `calloc` 函数的另一个好处是，它可以让系统在使用页面时初始化页面，而不是一次完成。

### 3.1.3 重用临时内存缓冲区 - Reuse Temporary Memory Buffers
如果您有一个经常用来为某些计算创建大型临时缓冲区的函数，则可能需要考虑重新使用该缓冲区，而不是在每次调用该函数时重新分配该缓冲区。即使你的函数需要一个可变的缓冲区空间，你也可以根据需要使用 `realloc` 函数来增加缓冲区。对于多线程应用程序，重用缓冲区的最佳方式是将它们添加到线程本地存储中。尽管可以在函数中使用静态变量来存储缓冲区，但这样做会阻止您同时在多个线程上使用该函数。

缓存缓冲区消除了定期分配和释放大块内存的函数的大部分开销。但是，这种技术只适用于频繁调用的函数。另外，你应该小心不要缓存太多的大缓冲区。缓存缓冲区确实会增加应用程序的内存占用空间，只有在测试表明它会产生更好的性能时才能使用。

### 3.1.4 释放未使用的内存 - Free Unused Memory
对于使用 `malloc` 库分配的内存，一旦完成使用，释放内存非常重要。忘记释放内存会导致内存泄漏，这会减少应用程序可用的内存量并影响性能。如果不加限制，内存泄漏也会使应用程序进入无法执行任何操作的状态，因为它无法分配所需的内存。

> 注意：使用自动引用计数（**ARC**）编译器选项构建的应用程序不需要明确释放 **Objective-C** 对象。相反，应用程序必须存储对想要保留的对象的强引用，并移除它不需要的对象的强引用。当一个对象没有强引用时，编译器会自动释放它。有关支持 **ARC** 的更多信息，请参阅 [Transitioning to ARC Release Notes](https://developer.apple.com/library/content/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html#//apple_ref/doc/uid/TP40011226)。

无论您选择哪个平台，都应该消除应用程序中的内存泄漏。对于使用 `malloc` 的代码，请记住懒惰对分配内存很好，但不要懒得释放内存。为帮助跟踪应用程序中的内存泄漏，请使用 **Instruments** 应用程序